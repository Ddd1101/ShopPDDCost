<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.1/package/dist/xlsx.full.min.js"></script>
    <script>
        let en_code = ['s','S','m','M', 'l','L','x','X']

        let worksheet = null
        // 从文件数据中解析出excel内容
        function parse(data) {
            const workbook = XLSX.read(data); // 从原始数据获取工作簿
                                              // 后端使用可以使用 readFile() 方法直接读取文件

            var first_sheet_name = workbook.SheetNames[0]; // 获得第一个工作表名称

            worksheet = workbook.Sheets[first_sheet_name]; // 获取工作表

            console.log(worksheet['A1']); // 读取并打印A1端元格数据

            console.log(worksheet['!merges']); // 打印所有合并单元格信息数组
            
            console.log(worksheet['!ref']); // 打印输出当前工作表使用的范围

            let goodTree = {}

            // 品名整理
            var range = XLSX.utils.decode_range(worksheet['!ref']);
            var totalRows = range.e.r - range.s.r + 1;
            
            goodTree = {}

            for(var i = 1; i < totalRows; ++i) {
                var cellValue = readCell(i, 4);
                skuTmp = cellValue.split(',');
                // 品名
                goodName = readCell(i, 1)
                // 规格
                size = NumFormate4Print(skuTmp[1])
                // 数量
                var isDouble = (skuTmp[0].includes('两') || skuTmp[0].includes('双条'));
                num = readCell(i, 8).split('.')[0]
                // 花型
                if (!isDouble) {
                    // 花色
                    sku = skuTmp[0].split('【')[0]
                    console.log("花色 " + sku);
                    // 品名
                    if (!(goodName in goodTree)) {
                        goodTree[goodName] = {};
                    }
                    // 品名 - 花色
                    if (!(sku in goodTree[goodName])) {
                        goodTree[goodName][sku] = {};
                    }
                    // 品名 - 花色 - 规格
                    if (!(size in goodTree[goodName][sku])) {
                        goodTree[goodName][sku][size] = num;
                    } else {
                        goodTree[goodName][sku][size] += num;
                    }
                } else {
                    isDiff = ('+' in skuTmp[0]);
                    if(!isDiff){
                        // 花色
                        sku = skuTmp[0].split('【')[0][0];
                        num *= 2;
                        // 品名
                        if (!(goodName in goodTree)) {
                            goodTree[goodName] = {}
                        }
                        // 品名 - 花色
                        if (!(sku in goodTree[goodName])) {
                            goodTree[goodName][sku] = {};
                        }
                        // 品名 - 花色 - 规格
                        if (!(size in goodTree[goodName][sku])) {
                            goodTree[goodName][sku][size] = num;
                        } else {
                            goodTree[goodName][sku][size] += num;
                        }
                    } else {
                        // 花色
                        if (goodName == "纯棉秋裤") {
                            sku1 = skuTmp[0].split('】')[1].split('+')[0];
                            sku2 = skuTmp[0].split('】')[1].split('+')[1];
                        } else if (goodName == "女童安全裤") {
                            sku1 = skuTmp[0].split('】')[1].split('+')[0];
                            sku2 = skuTmp[0].split('】')[1].split('+')[1];
                        } else {
                            sku1 = skuTmp[0].split('【')[0].split('+')[0];
                            sku2 = skuTmp[0].split('【')[0].split('+')[1];
                        }
                        // 品名
                        if (!(goodName in goodTree)) {
                            goodTree[goodName] = {}
                        }
                        // 品名 - 花色1
                        if (!(sku1 in goodTree[goodName])) {
                            goodTree[goodName][sku1] = {};
                        }
                        // 品名 - 花色1 - 规格
                        if (!(size in goodTree[goodName][sku1])) {
                            goodTree[goodName][sku1][size] = num;
                        } else {
                            goodTree[goodName][sku1][size] += num;
                        }
                        // 品名 - 花色2
                        if (!(sku2 in goodTree[goodName])) {
                            goodTree[goodName][sku2] = {};
                        } 
                        // 品名 - 花色2 - 规格
                        if (!(size in goodTree[goodName][sku2])) {
                            goodTree[goodName][sku2][size] = num;
                        } else {
                            goodTree[goodName][sku2][size] += num;
                        }
                    }
                }
            }

            console.log(goodTree);

        }

        function readCell(x, y){
            var cellCoordinates = {c: y, r: x};
            desiredCell = worksheet[XLSX.utils.encode_cell(cellCoordinates)];
            var cellValue = desiredCell ? desiredCell.v : undefined;
            return cellValue;
        }

        function NumFormate4Print(numStr) {
            var res = "";
            if (en_code.includes(numStr[0])){
                for (var i = 0; i < numStr.length; i++) { 
                    if (en_code.includes(numStr[i])) {
                        res += numStr[i]; 
                    } else { 
                        break;
                    }
                }

                let fomateSpaceNum = 5 - res.length;

                for (var k = 0; k < fomateSpaceNum; k++) {
                    res = " " + res; 
                }
            } else {
                for (var i = 0; i < numStr.length; i++) {
                    if (numStr[i] >= '0' && numStr[i] <= '9') {
                        res += numStr[i];
                    } else {
                        if (res[0] == '9') {
                            res += " ";
                        }
                        break;
                    }
                }
                res += "cm";
            }

            return res;
        }

        // 读取文件数据
        function read(file) {
            let reader = new FileReader();
            reader.onload = function (e) {
                parse(e.target.result);
            };
            reader.readAsArrayBuffer(file);
        }


    </script>
</head>

<body>
    <input type="file" onchange="read(this.files[0])" /><br>
</body>

</html>